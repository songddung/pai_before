stages:
  - test
  - detect-changes
  - build
  - deploy

variables:
  DOCKER_IMAGE_PREFIX: 'songhyunkwang'
  DOCKER_DRIVER: overlay2
  # Docker BuildKit í™œì„±í™”
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain
  # Git ì„¤ì •
  GIT_DEPTH: 0 # ì–•ì€ í´ë¡  ë°©ì§€
  GIT_STRATEGY: fetch

# 1) í…ŒìŠ¤íŠ¸ ë‹¨ê³„
test:
  stage: test
  image: node:20
  script:
    - echo "Running tests for changed services..."
    # ì—¬ê¸°ì— ë‚˜ì¤‘ì— ì‹¤ì œ í…ŒìŠ¤íŠ¸ ì¶”ê°€
    - echo "Tests completed"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  tags:
    - docker

# 2) ë³€ê²½ ê°ì§€ ë‹¨ê³„
detect-changes:
  stage: detect-changes
  image: alpine:latest
  before_script:
    - apk add --no-cache git bash
  script:
    - echo "Detecting changed services..."
    - echo "Current commit:$CI_COMMIT_SHA"
    - echo "Branch:$CI_COMMIT_BRANCH"
    - |
      # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ì—¬ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      if [ "$CI_COMMIT_BRANCH" = "develop" ] || [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "sub" ]; then
        # develop/master ë¸Œëœì¹˜: ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ (fallback í¬í•¨)
        if git rev-parse HEAD~1 >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        else
          echo "No previous commit found, treating as initial commit"
          CHANGED_FILES=$(git ls-files)
        fi
      else
        # ë‹¤ë¥¸ ë¸Œëœì¹˜: developê³¼ ë¹„êµ
        git fetch origin develop:develop 2>/dev/null || git fetch origin develop 2>/dev/null || true
        if git rev-parse develop >/dev/null 2>&1; then
          CHANGED_FILES=$(git diff --name-only develop...HEAD)
        else
          echo "develop branch not found, using all files"
          CHANGED_FILES=$(git ls-files)
        fi
      fi
    - echo "Changed files:"
    - echo "$CHANGED_FILES"
    - |
      # ì´ˆê¸°ê°’ ì„¤ì •
      echo "USER_SERVICE_CHANGED=false" > changes.env
      echo "MEDIA_SERVICE_CHANGED=false" >> changes.env
      echo "ARK_SERVICE_CHANGED=false" >> changes.env
      echo "CONVERSATION_SERVICE_CHANGED=false" >> changes.env
      echo "QUIZ_SERVICE_CHANGED=false" >> changes.env
      echo "AI_SERVICE_CHANGED=false" >> changes.env
      echo "GATEWAY_CHANGED=false" >> changes.env
      echo "SHARED_CHANGED=false" >> changes.env
    - |
      # ê³µí†µ/ê³µìœ  íŒŒì¼ íŒ¨í„´ (ì´ê²ƒë“¤ì´ ë³€ê²½ë˜ë©´ ëª¨ë“  ì„œë¹„ìŠ¤ ì¬ë¹Œë“œ)
      SHARED_PATTERNS="package\.json|package-lock\.json|yarn\.lock|shared-types/|BE/package\.json|BE/libs/|tsconfig|\.env|docker-compose|Dockerfile\.base|nx\.json|\.gitlab-ci\.yml|infra/"

      if echo "$CHANGED_FILES" | grep -E "$SHARED_PATTERNS" > /dev/null 2>&1; then
        echo "Shared files changed, rebuilding all services"
        echo "USER_SERVICE_CHANGED=true" > changes.env
        echo "MEDIA_SERVICE_CHANGED=true" >> changes.env
        echo "ARK_SERVICE_CHANGED=true" >> changes.env
        echo "CONVERSATION_SERVICE_CHANGED=true" >> changes.env
        echo "QUIZ_SERVICE_CHANGED=true" >> changes.env
        echo "AI_SERVICE_CHANGED=true" >> changes.env
        echo "GATEWAY_CHANGED=true" >> changes.env
        echo "SHARED_CHANGED=true" >> changes.env
      else
        # ê°œë³„ ì„œë¹„ìŠ¤ ë³€ê²½ í™•ì¸ (ê¸°ì¡´ false ê°’ì„ ë®ì–´ì“°ê¸°)
        if echo "$CHANGED_FILES" | grep "BE/apps/user-service/" > /dev/null 2>&1; then
          sed -i 's/USER_SERVICE_CHANGED=false/USER_SERVICE_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "BE/apps/media-service/" > /dev/null 2>&1; then
          sed -i 's/MEDIA_SERVICE_CHANGED=false/MEDIA_SERVICE_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "BE/apps/ark-service/" > /dev/null 2>&1; then
          sed -i 's/ARK_SERVICE_CHANGED=false/ARK_SERVICE_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "BE/apps/conversation-service/" > /dev/null 2>&1; then
          sed -i 's/CONVERSATION_SERVICE_CHANGED=false/CONVERSATION_SERVICE_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "BE/apps/quiz-service/" > /dev/null 2>&1; then
          sed -i 's/QUIZ_SERVICE_CHANGED=false/QUIZ_SERVICE_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "BE/apps/gateway/" > /dev/null 2>&1; then
          sed -i 's/GATEWAY_CHANGED=false/GATEWAY_CHANGED=true/' changes.env
        fi
        if echo "$CHANGED_FILES" | grep "AI_integration/" > /dev/null 2>&1; then
          sed -i 's/AI_SERVICE_CHANGED=false/AI_SERVICE_CHANGED=true/' changes.env
        fi
      fi
    - echo "=== Change Detection Results ==="
    - cat changes.env
  artifacts:
    reports:
      dotenv: changes.env
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  tags:
    - docker

# 3) ê°œë³„ ì„œë¹„ìŠ¤ ë¹Œë“œ ì‘ì—…ë“¤
build-user-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - |
      # ìŠ¤í¬ë¦½íŠ¸ ê°€ë“œ: ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ê±´ë„ˆë›°ê¸°
      if [ "$USER_SERVICE_CHANGED" != "true" ]; then
        echo "user-service has no changes, skipping build"
        exit 0
      fi
    - echo "Installing dependencies and building shared-types..."
    - npm ci
    - cd shared-types && npm ci && cd ..
    - npx nx build shared-types
    - echo "Checking dist folder..."
    - ls -la dist/
    - echo "Building user-service..."
    - docker build -f BE/apps/user-service/Dockerfile -t $DOCKER_IMAGE_PREFIX/user-service:latest -t $DOCKER_IMAGE_PREFIX/user-service:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/user-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/user-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-media-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - |
      if [ "$MEDIA_SERVICE_CHANGED" != "true" ]; then
        echo "media-service has no changes, skipping build"
        exit 0
      fi
    - echo "Installing dependencies and building shared-types..."
    - npm ci
    - cd shared-types && npm ci && cd ..
    - npx nx build shared-types
    - echo "Building media-service..."
    - docker build -f BE/apps/media-service/Dockerfile -t $DOCKER_IMAGE_PREFIX/media-service:latest -t $DOCKER_IMAGE_PREFIX/media-service:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/media-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/media-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-ark-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - |
      if [ "$ARK_SERVICE_CHANGED" != "true" ]; then
        echo "ark-service has no changes, skipping build"
        exit 0
      fi
    - echo "Installing dependencies and building shared-types..."
    - npm ci
    - cd shared-types && npm ci && cd ..
    - npx nx build shared-types
    - echo "Checking dist folder..."
    - ls -la dist/
    - echo "Building ark-service..."
    - docker build -f BE/apps/ark-service/Dockerfile -t $DOCKER_IMAGE_PREFIX/ark-service:latest -t $DOCKER_IMAGE_PREFIX/ark-service:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/ark-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/ark-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-conversation-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - |
      if [ "$CONVERSATION_SERVICE_CHANGED" != "true" ]; then
        echo "conversation-service has no changes, skipping build"
        exit 0
      fi
    - echo "Installing dependencies and building shared-types..."
    - npm ci
    - cd shared-types && npm ci && cd ..
    - npx nx build shared-types
    - echo "Checking dist folder..."
    - ls -la dist/
    - echo "Building conversation-service..."
    - docker build -f BE/apps/conversation-service/Dockerfile -t $DOCKER_IMAGE_PREFIX/conversation-service:latest -t $DOCKER_IMAGE_PREFIX/conversation-service:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/conversation-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/conversation-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-quiz-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  before_script:
    - apk add --no-cache nodejs npm
  script:
    - |
      if [ "$QUIZ_SERVICE_CHANGED" != "true" ]; then
        echo "quiz-service has no changes, skipping build"
        exit 0
      fi
    - echo "Installing dependencies and building shared-types..."
    - npm ci
    - cd shared-types && npm ci && cd ..
    - npx nx build shared-types
    - echo "Checking dist folder..."
    - ls -la dist/
    - echo "Building quiz-service..."
    - docker build -f BE/apps/quiz-service/Dockerfile -t $DOCKER_IMAGE_PREFIX/quiz-service:latest -t $DOCKER_IMAGE_PREFIX/quiz-service:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/quiz-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/quiz-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-ai-service:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  script:
    - |
      if [ "$AI_SERVICE_CHANGED" != "true" ]; then
        echo "ai-service has no changes, skipping build"
        exit 0
      fi
    - echo "Building ai-service..."
    - docker build -f AI_integration/Dockerfile -t $DOCKER_IMAGE_PREFIX/ai-service:latest -t $DOCKER_IMAGE_PREFIX/ai-service:$CI_COMMIT_SHA ./AI_integration
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/ai-service:latest
    - docker push $DOCKER_IMAGE_PREFIX/ai-service:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
    - if: '$CI_COMMIT_BRANCH == "feature/BE-users"'
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

build-gateway:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: 'tcp://docker:2375'
    DOCKER_TLS_CERTDIR: ''
  script:
    - |
      if [ "$GATEWAY_CHANGED" != "true" ]; then
        echo "gateway has no changes, skipping build"
        exit 0
      fi
    - echo "Building gateway..."
    - docker build -f BE/apps/gateway/Dockerfile -t $DOCKER_IMAGE_PREFIX/gateway:latest -t $DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHA .
    - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - docker push $DOCKER_IMAGE_PREFIX/gateway:latest
    - docker push $DOCKER_IMAGE_PREFIX/gateway:$CI_COMMIT_SHA
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  needs:
    - job: detect-changes
      artifacts: true
  tags:
    - docker

# 4) ë°°í¬ ë‹¨ê³„ - ìˆœì°¨ì  ì„œë¹„ìŠ¤ ì¬ì‹œì‘
deploy:
  stage: deploy
  # image: alpine:latest 09.24 ê°‘ìê¸° ì™œ ë°”ë€Œì—ˆëƒ ì§„ì§œ ê°œë¹¡ì¹˜ë„¤
  image: ubuntu:22.04
  before_script:
    - apt-get update && apt-get install -y openssh-client curl jq
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' > /tmp/ssh_key_test && chmod 600 /tmp/ssh_key_test
    - ssh-keygen -y -f /tmp/ssh_key_test > /dev/null || echo "INVALID_OR_PASSPHRASE"
    - rm /tmp/ssh_key_test
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' > /tmp/ssh_key
    - chmod 600 /tmp/ssh_key
    - ssh-add /tmp/ssh_key
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H j13c101.p.ssafy.io >> ~/.ssh/known_hosts
  script:
    - echo "Deploying services with changes..."
    - |
      # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ëª©ë¡ ìˆ˜ì§‘
      SERVICES_TO_DEPLOY=""
      [ "$USER_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY user-service"
      [ "$MEDIA_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY media-service"
      [ "$ARK_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY ark-service"
      [ "$CONVERSATION_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY conversation-service"
      [ "$QUIZ_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY quiz-service"
      [ "$AI_SERVICE_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY ai-service"
      [ "$GATEWAY_CHANGED" = "true" ] && SERVICES_TO_DEPLOY="$SERVICES_TO_DEPLOY gateway"

      echo "Services to deploy: $SERVICES_TO_DEPLOY"

      if [ -z "$SERVICES_TO_DEPLOY" ]; then
        echo "No services to deploy, skipping deployment"
        exit 0
      fi

      # ìˆœì°¨ì  ë°°í¬ë¥¼ ìœ„í•œ ì„œë¹„ìŠ¤ ìš°ì„ ìˆœìœ„ (ì˜ì¡´ì„± ê³ ë ¤)
      # 1. ë°±ì—”ë“œ ì„œë¹„ìŠ¤ë“¤ ë¨¼ì € (gateway ì œì™¸)
      # 2. gateway ë§ˆì§€ë§‰ (í”„ë¡ì‹œ ì—­í• )
      SERVICE_ORDER="user-service media-service ark-service conversation-service quiz-service ai-service gateway"

      ssh -o StrictHostKeyChecking=yes ubuntu@j13c101.p.ssafy.io "
        set -e
        cd ~ &&

        # ë°°í¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡ (GitLab CIì—ì„œ ì „ë‹¬)
        TARGETS=\"$SERVICES_TO_DEPLOY\"
        echo 'Starting deployment process...' &&
        echo \"Target services: \$TARGETS\" &&

        # TARGETSê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¢…ë£Œ
        if [ -z \"\$TARGETS\" ]; then
          echo 'No services to deploy, exiting'
          exit 0
        fi &&

        # ë°°í¬ ì „ í™˜ê²½ ê²€ì¦
        echo 'Validating deployment environment...' &&
        ls -la &&
        pwd &&
        echo 'Checking docker-compose.yml...' &&
        if [ ! -f docker-compose.yml ]; then
          echo 'ERROR: docker-compose.yml not found!'
          exit 1
        fi &&
        echo 'Validating docker-compose configuration...' &&
        docker compose config -q &&

        # ì „ì²´ ì´ë¯¸ì§€ pull ë¨¼ì € ìˆ˜í–‰
        echo 'Pulling latest images...' &&
        docker compose pull \$TARGETS &&

        # ìˆœì°¨ì ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¬ì‹œì‘
        SERVICE_ORDER=\"user-service media-service ark-service conversation-service quiz-service ai-service gateway\"
        for service in \$SERVICE_ORDER; do
          if echo \" \$TARGETS \" | grep -Fq \" \$service \"; then
            echo \"=== Deploying \$service ===\" &&

            # í—¬ìŠ¤ì²´í¬ê°€ ìˆë‹¤ë©´ ì´ì „ ìƒíƒœ í™•ì¸
            if docker compose ps \$service --format json 2>/dev/null | grep -q '\"Health\":\"healthy\"'; then
              echo \"\$service is currently healthy\"
            fi &&

            # ì„œë¹„ìŠ¤ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì „)
            if [ \"\$service\" = \"user-service\" ] && echo \" \$TARGETS \" | grep -Fq \" user-service \"; then
              echo \"Running user-service database migration...\" &&
              docker compose up -d --no-deps user-service &&
              sleep 5 &&
              docker exec --user root user-service npx prisma migrate deploy
            elif [ \"\$service\" = \"media-service\" ] && echo \" \$TARGETS \" | grep -Fq \" media-service \"; then
              echo \"Running media-service database migration...\" &&
              docker compose up -d --no-deps media-service &&
              sleep 5 &&
              docker exec --user root media-service npx prisma migrate deploy
            elif [ \"\$service\" = \"ark-service\" ] && echo \" \$TARGETS \" | grep -Fq \" ark-service \"; then
              echo \"Running ark-service database migration...\" &&
              docker compose up -d --no-deps ark-service &&
              sleep 5 &&
              docker exec --user root ark-service npx prisma migrate deploy
            elif [ \"\$service\" = \"conversation-service\" ] && echo \" \$TARGETS \" | grep -Fq \" conversation-service \"; then
              echo \"Running conversation-service database migration...\" &&
              docker compose up -d --no-deps conversation-service &&
              sleep 5 &&
              docker exec --user root conversation-service npx prisma migrate deploy
            elif [ \"\$service\" = \"quiz-service\" ] && echo \" \$TARGETS \" | grep -Fq \" quiz-service \"; then
              echo \"Running quiz-service database migration...\" &&
              docker compose up -d --no-deps quiz-service &&
              sleep 5 &&
              docker exec --user root quiz-service npx prisma migrate deploy
            else
              # Gatewayë‚˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ í•„ìš”ì—†ëŠ” ì„œë¹„ìŠ¤ëŠ” ì¼ë°˜ ì¬ì‹œì‘
              echo \"Starting \$service...\" &&
              docker compose up -d --no-deps \$service
            fi &&

            # ì ì‹œ ëŒ€ê¸° (ì„œë¹„ìŠ¤ ì‹œì‘ ì‹œê°„ ê³ ë ¤)
            echo \"Waiting for \$service to start...\" &&
            sleep 10 &&

            # ìƒˆ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo \"Checking \$service status...\" &&
            docker compose ps \$service &&
            if ! docker compose ps \$service --format json | grep -q '\"State\":\"running\"'; then
              echo \"ERROR: \$service failed to start properly\" &&
              echo \"Container logs:\" &&
              docker compose logs --tail=50 \$service &&
              exit 1
            fi &&

            echo \"\$service deployed successfully\" &&
            echo \"---\"
          fi
        done &&

        echo 'Cleaning up unused images...' &&
        docker image prune -f &&

        echo 'Deployment completed successfully!'
      "

  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH == "sub"' # í…ŒìŠ¤íŠ¸ìš© ë¸Œëœì¹˜
  resource_group: deployment
  needs:
    - job: detect-changes
      artifacts: true
    - job: build-user-service
      optional: true
    - job: build-media-service
      optional: true
    - job: build-ark-service
      optional: true
    - job: build-conversation-service
      optional: true
    - job: build-quiz-service
      optional: true
    - job: build-gateway
      optional: true
  tags:
    - docker

# 5) í”„ë¡œë•ì…˜ ë°°í¬ (master ë¸Œëœì¹˜ë§Œ) - ë” ì—„ê²©í•œ ë°°í¬ í”„ë¡œì„¸ìŠ¤
deploy-production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh curl jq
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | base64 -d | tr -d '\r' > /tmp/ssh_key
    - chmod 600 /tmp/ssh_key
    - ssh-add /tmp/ssh_key
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H j13c101.p.ssafy.io >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ Starting PRODUCTION deployment..."
    - |
      # ë³€ê²½ëœ ì„œë¹„ìŠ¤ í™•ì¸
      PROD_SERVICES=""
      [ "$USER_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES user-service"
      [ "$MEDIA_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES media-service"
      [ "$ARK_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES ark-service"
      [ "$CONVERSATION_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES conversation-service"
      [ "$QUIZ_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES quiz-service"
      [ "$AI_SERVICE_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES ai-service"
      [ "$GATEWAY_CHANGED" = "true" ] && PROD_SERVICES="$PROD_SERVICES gateway"

      if [ -z "$PROD_SERVICES" ]; then
        echo "âš ï¸  No services to deploy to production"
        exit 0
      fi

      echo "ğŸ“¦ Services to deploy to PRODUCTION: $PROD_SERVICES"

      ssh -o StrictHostKeyChecking=yes ubuntu@j13c101.p.ssafy.io "
        set -e
        cd ~ &&

        # í”„ë¡œë•ì…˜ ë°°í¬ ëŒ€ìƒ ì„œë¹„ìŠ¤ ëª©ë¡ (GitLab CIì—ì„œ ì „ë‹¬)
        PROD_TARGETS=\"$PROD_SERVICES\"
        echo 'ğŸ” Pre-deployment checks...' &&
        echo \"ğŸ“¦ Production targets: \$PROD_TARGETS\" &&

        # PROD_TARGETSê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¢…ë£Œ
        if [ -z \"\$PROD_TARGETS\" ]; then
          echo 'âš ï¸  No services to deploy to production, exiting'
          exit 0
        fi &&

        # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ ìƒíƒœ ë°±ì—…
        docker compose ps --format json > /tmp/pre_deploy_status.json &&

        # ì´ë¯¸ì§€ pull
        echo 'ğŸ“¥ Pulling production images...' &&
        docker compose pull \$PROD_TARGETS &&

        # ìˆœì°¨ì  í”„ë¡œë•ì…˜ ë°°í¬ (ë” ë³´ìˆ˜ì )
        SERVICE_ORDER=\"user-service media-service ark-service conversation-service quiz-service ai-service gateway\"

        for service in \$SERVICE_ORDER; do
          if echo \" \$PROD_TARGETS \" | grep -Fq \" \$service \"; then
            echo \"ğŸ”„ Deploying \$service to production...\" &&

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            OLD_STATUS=\$(docker compose ps \$service --format json 2>/dev/null || echo '{}') &&

            # í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ë³„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            if [ \"\$service\" = \"user-service\" ]; then
              echo \"ğŸ—„ï¸ Running user-service production migration...\" &&
              docker compose up -d --no-deps user-service &&
              sleep 10 &&
              docker exec --user root user-service npx prisma migrate deploy
            elif [ \"\$service\" = \"media-service\" ]; then
              echo \"ğŸ—„ï¸ Running media-service production migration...\" &&
              docker compose up -d --no-deps media-service &&
              sleep 10 &&
              docker exec --user root media-service npx prisma migrate deploy
            elif [ \"\$service\" = \"ark-service\" ]; then
              echo \"ğŸ—„ï¸ Running ark-service production migration...\" &&
              docker compose up -d --no-deps ark-service &&
              sleep 10 &&
              docker exec --user root ark-service npx prisma migrate deploy
            elif [ \"\$service\" = \"conversation-service\" ]; then
              echo \"ğŸ—„ï¸ Running conversation-service production migration...\" &&
              docker compose up -d --no-deps conversation-service &&
              sleep 10 &&
              docker exec --user root conversation-service npx prisma migrate deploy
            elif [ \"\$service\" = \"quiz-service\" ]; then
              echo \"ğŸ—„ï¸ Running quiz-service production migration...\" &&
              docker compose up -d --no-deps quiz-service &&
              sleep 10 &&
              docker exec --user root quiz-service npx prisma migrate deploy
            else
              # GatewayëŠ” ì¼ë°˜ Blue-Green ë°°í¬
              docker compose up -d --no-deps \$service
            fi &&

            # ë” ê¸´ ëŒ€ê¸° ì‹œê°„ (í”„ë¡œë•ì…˜ì´ë¯€ë¡œ)
            echo \"â³ Waiting for \$service to stabilize...\" &&
            sleep 20 &&

            # ìƒíƒœ ê²€ì¦
            if ! docker compose ps \$service --format json | grep -q '\"State\":\"running\"'; then
              echo \"âŒ ERROR: \$service failed in production! Rolling back...\" &&
              # ê°„ë‹¨í•œ ë¡¤ë°± ì‹œë„
              docker compose restart \$service &&
              exit 1
            fi &&

            # í—¬ìŠ¤ì²´í¬ (ìˆë‹¤ë©´)
            if docker compose ps \$service --format json | grep -q '\"Health\"'; then
              echo \"ğŸ¥ Waiting for \$service health check...\" &&
              for i in \$(seq 1 12); do  # 2ë¶„ ëŒ€ê¸°
                if docker compose ps \$service --format json | grep -q '\"Health\":\"healthy\"'; then
                  echo \"âœ… \$service is healthy\"
                  break
                fi
                sleep 10
                echo \"â³ Health check attempt \$i/12...\"
              done
            fi &&

            echo \"âœ… \$service deployed successfully to production\"
          fi
        done &&

        echo 'ğŸ§¹ Cleaning up old images...' &&
        docker image prune -f &&

        echo 'ğŸ‰ PRODUCTION deployment completed successfully!'
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: false
  resource_group: deployment
  needs:
    - job: detect-changes
      artifacts: true
  environment:
    name: production
    url: https://j13c101.p.ssafy.io
  tags:
    - docker
